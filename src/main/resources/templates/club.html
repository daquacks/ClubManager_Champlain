<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Club Details | Hub</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e4ecef; }
        header { background-color: #3a4581; color: #fff; padding: 1rem; text-align: center; }
        h1 { margin: 0 auto; }
        
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .club-info { border-bottom: 2px solid #679b9b; margin-bottom: 2rem; padding-bottom: 1rem; position: relative; }
        .club-info h2 { color: #333; margin-bottom: 10px; }
        .club-info p { color: #555; line-height: 1.6; font-size: 1.1rem; }

        .action-buttons {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
            align-items: center; /* Ensures all buttons align vertically */
        }

        /* Standardized button style for all 3 buttons */
        .discord-btn, .join-btn, .edit-btn {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-size: 0.9rem; /* Forces identical text size */
            white-space: nowrap; /* Prevents text wrapping */
        }

        .edit-btn {
            background-color: #6c757d; /* Gray color for Edit */
            color: white;
        }
        .edit-btn:hover { background-color: #5a6268; }

        .discord-btn { background-color: #5865F2; color: white; }
        .discord-btn:hover { background-color: #4752C4; }

        .join-btn { background-color: #28a745; color: white; }
        .join-btn:hover { background-color: #218838; }

        .event-section h3 { color: #333; border-left: 5px solid #679b9b; padding-left: 10px; margin-bottom: 1.5rem; }

        .event-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            transition: box-shadow 0.3s;
        }
        .event-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .event-date {
            flex: 0 0 70px;
            text-align: center;
            background-color: #007bff;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
        }
        .event-date .month { font-size: 0.8rem; text-transform: uppercase; }
        .event-date .day { font-size: 1.8rem; font-weight: bold; }

        .event-details { flex-grow: 1; }
        .event-details h4 { margin: 0 0 5px 0; color: #333; font-size: 1.2rem; }
        .event-details p { margin: 0.2rem 0; color: #666; font-size: 0.95rem; }
        .event-details .meta { font-size: 0.85rem; color: #888; margin-top: 5px; }

        .loading { font-style: italic; color: #888; }
        .error { color: red; }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">Club Hub</h1>
</header>

<div th:replace="~{fragments :: navbar}"></div>

<div class="container">
    <div class="club-info">
        <div class="action-buttons">
            <a id="edit-club-link" href="#" class="edit-btn">
                Edit Club
            </a>
            <a id="join-discord-link" href="#" target="_blank" class="join-btn">
                Join Discord Server
            </a>
            <button id="share-discord-btn" class="discord-btn" onclick="shareToDiscord()">
                Share to Discord
            </button>
        </div>
        <h2 id="club-name">Loading...</h2>
        <p id="club-description">Fetching description...</p>
    </div>

    <div class="event-section">
        <h3>Upcoming Events</h3>
        <div id="event-list">
            <p class="loading">Loading events...</p>
        </div>
    </div>
</div>

<script>
    // Extract the ID from the URL: /clubs/12345
    // Handle potential trailing slash
    const pathParts = window.location.pathname.split('/').filter(part => part.length > 0);
    const clubId = pathParts[pathParts.length - 1];

    console.log("Fetching details for club ID:", clubId);

    if (!clubId) {
        console.error("No club ID found in URL");
        document.getElementById('club-name').innerText = "Error";
        document.getElementById('club-description').innerText = "Invalid Club ID.";
    } else {
        // Fetch the specific Club data
        fetch(`/api/clubs/${clubId}`)
            .then(res => {
                if (!res.ok) throw new Error(`Club not found (Status: ${res.status})`);
                return res.json();
            })
            .then(club => {
                console.log("Club data received:", club);
                document.getElementById('header-title').innerText = club.name;
                document.getElementById('club-name').innerText = club.name;
                document.getElementById('club-description').innerText = club.description;

                document.getElementById('edit-club-link').href = `/club-edit/${clubId}`
                
                // Set Discord Link
                const joinBtn = document.getElementById('join-discord-link');
                if (club.discordLink) {
                    joinBtn.href = club.discordLink;
                } else {
                    joinBtn.style.display = 'none'; // Hide if no link
                }

                // Now fetch the events for this club using the CORRECT endpoint
                return fetch(`/api/events/club/${clubId}`);
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to fetch events');
                return res.json();
            })
            .then(events => {
                console.log("Events received:", events);
                const eventList = document.getElementById('event-list');
                eventList.innerHTML = ''; // Clear loading text

                if (events.length === 0) {
                    eventList.innerHTML = '<p>No upcoming events scheduled for this club.</p>';
                    return;
                }

                // Sort events by date
                events.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                events.forEach(event => {
                    const date = new Date(event.startTime);
                    const month = date.toLocaleString('default', { month: 'short' });
                    const day = date.getDate();
                    const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    const card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerHTML = `
                        <div class="event-date">
                            <div class="month">${month}</div>
                            <div class="day">${day}</div>
                        </div>
                        <div class="event-details">
                            <h4>${event.title}</h4>
                            <p>${event.description}</p>
                            <div class="meta">
                                <span>üìç ${event.location}</span> &nbsp;|&nbsp; 
                                <span>‚è∞ ${time}</span>
                            </div>
                        </div>
                    `;
                    eventList.appendChild(card);
                });
            })
            .catch(err => {
                console.error("Fetch error:", err);
                document.getElementById('club-name').innerText = "Error";
                document.getElementById('club-description').innerText = "Could not load club details: " + err.message;
                document.getElementById('event-list').innerHTML = '<p class="error">Error loading content.</p>';
            });
    }

    function shareToDiscord() {
        const btn = document.getElementById('share-discord-btn');
        const originalText = btn.innerText;
        btn.innerText = "Sharing...";
        btn.disabled = true;

        fetch(`/api/clubs/${clubId}/share`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    alert("Successfully shared to Discord!");
                } else {
                    alert("Failed to share to Discord.");
                }
            })
            .catch(error => {
                console.error('Error sharing to Discord:', error);
                alert("Error sharing to Discord.");
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }
</script>

</body>
</html>
